# REVM Consistency Checker

This crate contains a component that executes ZKsync OS blocks on an alternative implementation of the Execution Environment (EE) and compares the resulting state changes with those from the original EE. It uses a variant of REVM that supports all custom ZKsync OS features.

The consistency checker operates on already executed blocks because ZKsync REVM needs to know how much gas each transaction consumed. This is due to double accounting in ZKsync OS. Sometimes a transaction may consume more gas than it would on a vanilla EVM because it uses additional “native resources". 

To keep ZKsync REVM simple and efficient, it doesn’t calculate the cost of these “native resources” directly. Instead, the consistency checker provides a `gas_used_override` hint, indicating how much gas the transaction should actually be charged at the end. The same for failing transactions, REVM doesn't execute them but just assume that transaction is failling.

## Database

The consistency checker connects to the same database as other components and works with a snapshot of the state for each block. All intermediate state changes are stored in an in-memory cache database, which is dropped after each block execution and recreated for the next block. 

## Consistency check

The consistency checker looks for divergences in both storage diffs and account properties:
- nonce
- balance
- deployed bytecode

After re-executing a block, the consistency checker collects all touched accounts and storage slots from the in-memory cache database and compares them with those in the main database. Any discrepancies are considered storage diffs.

ZKsync OS block execution already produces a list of state diffs, so we compare that list with the state diffs generated by REVM.

## What happen if there is a divergence?

If ZKsync OS diverges from REVM, the component doesn’t crash. It only logs a warning.

## Limitations

The consistency checker doesn't check divergences in:
- L2 -> L1 messeges
- Events
- Gas used by the transaction (due to not implemented double accounting in REVM)
